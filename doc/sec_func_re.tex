\section{ФУНКЦИОНАЛЬНОЕ ПРОЕКТИРОВАНИЕ}
\label{sec:func}


\subsection{Алгоритм работы модуля выделения информационных образов из музыкального произведения}
    
На ход модуля чтения музыкального произведения подаётся путь к музыкальному произведению. Файл с расширением “.wav” считывается в оперативную память в формате массива отсчётов. Файл с иным расширением конвертируются в WAV формат. 

В модуле препроцессинга и нарезки от музыкального трека отрезается 10\% длины с начала и конца трека. В случае, если трек является многоканальным, то он приводится к одноканальному посредством чередованием правого и левого канала. Данные нормализуются по МО и СКО. Затем используется экспоненциальное сглаживание с коэффициентом сглаживания 0,99. Результат нарезается на фрагменты по 5 секунд с перекрытием в 0,5 секунды.

В модуле получения частотно-временного представления используется оконное преобразование Фурье с окном Хэмминга шириной в 10 миллисекунд. Также в модуле для получения ритмического образа используется вейвлет Добеши каскадным алгоритмом с количеством каскадов 4. Результат каждого каскада сглаживается экспоненциальным сглаживанием с коэффициентом сглаживания 0,97, передискретизируется с уменьшением дискретизации в 16 раз, нормализуется по МО. Затем результаты поэлементно складываются и вычисляется автокорелляция. Результатом работы модуля является спектрограмма и коррелограмма.

В модуле выделения информационных образов из временного представления сигнала выделяется временной, из спектрограммы - спектральный образ по каждому срезу спектрограммы, из коррелограммы - ритмический. Мел-кепстральные коэффициенты считаются по окнам в 5 миллисекунд. 

В модуле обработки информационных образов по всем образам кроме временного считается МО, СКО, коэффициент ассиметрии, коэффициент эксцесса.

В базу данных записывается информационный образ в формате: название произведения, номер фрагмента и результат работы модуля обработки информационных образов.  

В модуле классификации информационных образов используются набор стандартных алгоритмов классификации из библиотеки scikit-learn с параметрами по умолчанию:
\begin{enumerate}
\item метод ближайших соседей с k = 3;
\item метод опорных векторов с полиномиальным ядром;
\item дерево принятия решений;
\item случайный лес;
\item нейронная сеть прямого распространения с 1000 нейронов на скрытом слое;
\item adaBoost;
\itemнаивный баесовский классификатор;
\item квадратичный дискриминант.
\end{enumerate}

Для оценки качества классификации использовался скользящий контроль количеством разбиений равным 10 и алгоритмом разбиения stratified k-fold. Также для каждого классификатора строится матрица ошибок.

В модуле визуализации используется алгоритм t-sne.Это нелинейный метод уменьшения размерности, который особенно хорошо подходит для вложения высокоразмерных данных в пространство двух или трех измерений, которое затем можно визуализировать на диаграмме рассеяния. В частности, он моделирует каждый высокоразмерный объект с помощью двух- или трехмерной точки таким образом, что аналогичные объекты моделируются соседними точками, а разнородные объекты моделируются удаленными точками. Данные визуализируются в 2д и 3д графики. 


\subsection{Реализация внутренних модулей}
Рассмотрим в деталях функциональные части системы: для этого произведем детальный анализ компонентов, модулей, составляющих их классов и отдельных методов, реализующих логику программы.



Структурно система подразделяется на ряд модулей , объединенных под общим модулем с названием \texttt{MainModule}. Дальнейшее разделение ведется по следующим модулям:
\begin{enumerate}[label=\arabic*.]
\item{Модуль чтения музыкального произведения - \texttt{WavModule}.}
\item{Модуль препроцессинга и нарезки - \texttt{PreprocessingModule}.}
\item{Модуль получения частотно-временного представления сигнала -
 
\texttt{SpectralTransformerModule}.}
\item{Модуль извлечения информационных образов -

\texttt{FeatureExtractorModule}.}
\item{Модуль обработки информационных образов - 

\texttt{FeatureProcessingModule}. }
\item{База данных информационных образов - \texttt{DatabaseModule}.}
\item{Модуль жанровой классификации музыкального произведения -

\texttt{GenreClassificationModule}.}
\item{Модуль визуализации - \texttt{VisualizeDataModule}.}
\end{enumerate}


\subsubsection{Класс \texttt{Track}}

Класс \texttt{Track}  является абстрацией для хранения трека в виде массива отсчётов, частоты дискретизации и метаинформации о треке.

Класс \texttt{Track} имеет следующие  поля:
\begin{itemize}
\item{Поле \texttt{data} -- массив ndarray, который хранит в трек в виде отсчётов.}
\item{Поле \texttt{sample\_rate} -- частота дискретизации трека.}
\item{Поле \texttt{label} -- поле хранящее метаинформацию о треке.}
\end{itemize}

\subsubsection{Класс \texttt{SpectralTrack}}

Класс \texttt{SpectralTrack} наследуется от класса  \texttt{Track}  и  является абстрацией для хранения  спектра трека и его коррелограммы

Класс \texttt{Track} имеет следующие  поля:
\begin{itemize}
\item{Поле \texttt{spectra\_data} -- массив ndarray, который хранит спектрограмму трека, полученную с помощью оконного преобразования Фурье.}
\item{Поле \texttt{percussion\_data} -- масств ndarray, который хранит коррелограмму трека.}
\end{itemize}

\subsubsection{Класс \texttt{TrackModel}}

Класс \texttt{TrackModel} является абстракцией для хранения временного, спектрального, ритмического и мел-кепстрального образа.

Класс \texttt{TrackModel} имеет следующие  методы и поля:

\begin{itemize}
\item{Поле \texttt{timing\_features} -- массив ndarray, который хранит временной образ трека.}
\item{Поле \texttt{spectral\_features} -- масств ndarray, который хранит спектральный образ трека.}
\item{Поле \texttt{percussion\_features} -- массив ndarray, который хранит ритмический образ трека.}
\item{Поле \texttt{mfcc\_features} -- массив ndarray, который хранит мел-кепстраьный образ трека.}
\item{Поле \texttt{label} -- поле хранящее метаинформацию о треке .}
\item{\texttt{to\_vector()} -- метод, который конкатенирует образы. И возвращает одномерный массив типа ndarray.}
\end{itemize}


\subsubsection{Класс \texttt{WavModule}}

Класс \texttt{WavModule} предназначен для преобразования MP3 к формату WAV и считывании данных в Numpy-массив. 

Класс \texttt{WavModule} имеет следующие методы:

\begin{itemize}
\item{ \texttt{create\_wav(file\_name)}  процедура, которая принимает на вход путь к MP3-файлу и с помошью стандартной библиотеки Python вызывает либо bash-скрипт в случае запуска в операционной системе Linux, либо batch-скрипт в случае запуска в операционной системе Windows, который использует консольное приложение Lame для преобразования MP3-файла в WAV формат}
\item{ \texttt{read\_wav(filename, label)} - метод, который считывает файл формата WAV и сохраняет данные в класс \texttt{Track}}
\end{itemize}


\subsubsection{Класс \texttt{PreprocessingModule}}

Класс \texttt{PreprocessingModule} предназначен для первичной обработки трека, которая включает в себя приведения стерео звука к моно, нормализация по МО и СКО, 
удаления заданного процента трека с начала и с конца, экспоненциальное сглаживание и нарезка трека на фрагменты. В конструкторе задаётся коэффициент сглаживания, процент пересечения фрагментов, процент отсечения трека с начала, процент отсечения трека с конца, размер фрагмента в секундах.

Класс \texttt{PreprocessingModule} имеет следующие методы и поля:

\begin{itemize}
\item{Поле \texttt{alpha} -- коэффициент сглаживания, который может принимать значения от 0 до 1.}
\item{Поле \texttt{overlap} -- процент пересечения фрагментов.}
\item{Поле \texttt{cut\_start} -- процент отсечения трека с начала трека}
\item{Поле \texttt{cut\_end} -- процент отсечения трека с конца трека}
\item{Поле \texttt{frame\_size\_sec} -- размер фрагментов в секундах}
\item{\texttt{stereo\_to\_mono(track)} -- метод, который преобразует стерео звук к моно с помощью чередования правого и левого канала}
\item{\texttt{scale(track)} -- метод, который нормализует данные по МО и СКО}
\item{\texttt{filter(track)} -- метод, который преобразовывает данные искользуя экспоненциальное сглаживание:
\begin{equation}\label{eq:sfm}
s_t = \begin{cases} 
c_1, & t_1 = 0. \\
s_{t} + \alpha * (c_t - s_{t-1}), & t > 0
\end{cases} 
\end{equation}
где - $\alpha$ - коэффициент сглаживание заданные в поле \texttt{alpha}}
\item{\texttt{cutting(track)} -- метод, который отсекает процент данных трека с начала и конца, который задаётся полями \texttt{cut\_start} и \texttt{cut\_end}}
\item{\texttt{framing(track)} -- метод, который нарезает трека на фрагменты длинной заданной полем \texttt{frame\_size\_sec} и перекрытием заданным полем \texttt{overlap}.}
\end{itemize}


\subsubsection{Класс \texttt{SpectralTransformer}}

Класс \texttt{SpectralTransformer} предназначен для получения спектрально-временного представления трека, а также для получения коррелограммы. Спектрально-временное представление получается путём оконного преобразования Фурье (см. формулу \ref{eq:stft}) с окном Хемминга размером 10 миллисекунд (см. формулу \ref{eq:window})

\begin{equation}\label{eq:stft}
F(m, \omega) = \sum \limits_{n=-\infty}^{\infty} f[n]w[n-m]e^{-j \omega n} 
\end{equation}
\begin{equation}\label{eq:window}
w_i = 0.54 - 0.46 \cos\frac{2\pi i}{n-1}
\end{equation}

Также в модуле получает ритмические(перкуссионные) признаки. 

\begin{itemize}
\item{Поле \texttt{alpha} -- коэффициент сглаживания, который может принимать значения от 0 до 1.}
\item{Поле \texttt{window} -- массив, который содержит в себе окно Хемминга.}
\item{Поле \texttt{level} -- количество каскадов в }
\item{Поле \texttt{rate} -- частота передискретизации.}
\item{\texttt{short\_time\_fourier(track)} -- метод, который преобразует трек оконным преобразованием Фурье с окном Хемминга, возвращает двумерный массив амплитуд типа \texttt{ndarray} }
\item{\texttt{wavelet\_daubechies(data)} -- метод, который  делает вейвлет преобразования Добеши. }
\item{\texttt{filter(track)} -- метод, который преобразовывает данные искользуя экспоненциальное сглаживание.}
\item{\texttt{resampling(data)} -- метод, который передискретизирует данные в \texttt{rate} раз }
\item{\texttt{normalize\_and\_sum(track)} -- метод, который}
\end{itemize}

\subsubsection{Класс \texttt{FeatureExtractror}}

Класс \texttt{FeatureExtractror} предназначен для

\begin{itemize}
\item{Поле \texttt{time\_feature\_models} -- коэффициент сглаживания, который может принимать значения от 0 до 1.}
\item{Поле \texttt{spectre\_feature\_models} -- массив, который содержит в себе окно Хемминга.}
\item{Поле \texttt{results} -- количество каскадов в }
\item{Поле \texttt{nceps} -- частота передискретизации.}
\item{Поле \texttt{frame\_size} -- частота передискретизации.}
\item{\texttt{extract\_feature(track)} -- метод, }
\item{\texttt{extract\_percussion\_feature(track)} -- метод, который  делает вейвлет преобразования Добеши. }
\item{\texttt{extract\_mfcc(track)} -- метод, который преобразовывает данные искользуя экспоненциальное сглаживание.}
\item{\texttt{extract\_spectra\_feature(track)} -- метод, который передискретизирует данные в \texttt{rate} раз }
\item{\texttt{normalize\_and\_sum(track)} -- метод, который}
\end{itemize}

\subsubsection{Класс \texttt{FeatureExtractorModel}}

Класс \texttt{FeatureExtractorModel} абстрактный класс, который используется в качестве базового для классов, которые извлекают признак из временной или из спектральной области.

Класс \texttt{FeatureExtractorModel} имеет следующие методы:

\begin{itemize}
\item{\texttt{get(data, params)} -- метод, который принимает на вход ndarray и массив параметров, а на выход выдаёт признак типа float. В данном классе метод абстрактный }
\item{\texttt{normalize(result, data))} -- метод, который нормализует данные про размер входного массива}
\end{itemize}



\subsubsection{Класс \texttt{SpectralFeature}}

Класс \texttt{SpectralFeature} абстрактный класс, который используется в качестве базового для классов, который извлекают признак из спектральной области. Класс наследуется от \texttt{FeatureExtractorModel}.

\subsubsection{Класс \texttt{TimingFeature}}

Класс \texttt{TimingFeature} абстрактный класс, который используется в качестве базового для классов, который извлекают признак из временной области. Класс наследуется от \texttt{FeatureExtractorModel}.


\subsubsection{Класс \texttt{Energy}}

Класс \texttt{Energy} класс, который получает значение энергии сигнала из временной области (см. формулу \ref{eq:energy}). Класс наследуется от \texttt{TimingFeature}.

Класс \texttt{Energy} имеет следующие методы:

\begin{itemize}
\item{\texttt{get(data, params)} --  метод, который принимает на вход массив отсчётов, а на выход выдаёт энергию сигнала. }
\end{itemize}


\subsubsection{Класс \texttt{ZeroCrossingRate}}

Класс \texttt{ZeroCrossingRate} класс, который получает значение количества переходов сигнала через ноль из временной области (см. формулу \ref{eq:zcr}). Класс наследуется от \texttt{TimingFeature}.

Класс \texttt{ZeroCrossingRate} имеет следующие методы:

\begin{itemize}
\item{\texttt{get(data, params)} --  метод, который принимает на вход массив отсчётов, а на выход выдаёт количества переходов сигнала через ноль . }
\end{itemize}


\subsubsection{Класс \texttt{Autocorrelation}}

Класс \texttt{Autocorrelation} класс, который получает значение автокорреляцию первого рода из временной области (см. формулу \ref{eq:autocorrelation}). Класс наследуется от \texttt{TimingFeature}.

Класс \texttt{Autocorrelation} имеет следующие методы:

\begin{itemize}
\item{\texttt{get(data, params)} --  метод, который принимает на вход массив отсчётов, а на выход выдаёт автокорреляцию первого рода. }
\end{itemize}

\subsubsection{Класс \texttt{SpectralCentroid}}

Класс \texttt{SpectralCentroid} класс, который получает значение арифметического среднего взешенного из спектра (см. формулу \ref{eq:centroid}). Класс наследуется от \texttt{SpectralFeature}.

Класс \texttt{SpectralCentroid} имеет следующие методы:

\begin{itemize}
\item{\texttt{get(data, params)} --  метод, который принимает на вход массив отсчётов, а на выход  значение арифметического среднего взвешенного. }
\end{itemize}

\subsubsection{Класс \texttt{SpectralSmoothness}}

Класс \texttt{SpectralSmoothness} класс, который получает значение гладкости спектра (см. формулу \ref{eq:smooth}). Класс наследуется от \texttt{SpectralFeature}.

Класс \texttt{SpectralSmoothness} имеет следующие методы:

\begin{itemize}
\item{\texttt{get(data, params)} --  метод, который принимает на вход массив отсчётов, а на выход значение гладкости спектра . }
\end{itemize}

\subsubsection{Класс \texttt{LinearRegression}}

Класс \texttt{LinearRegression} класс, который получает значение линейной регрессии спектра  (см. формулу \ref{eq:regression}). Класс наследуется от \texttt{SpectralFeature}.

Класс \texttt{LinearRegression} имеет следующие методы:

\begin{itemize}
\item{\texttt{get(data, params)} --  метод, который принимает на вход массив отсчётов, а на выход  значение линейной регрессии спектра . }
\end{itemize}

\subsubsection{Класс \texttt{SpectralSpread}}

Класс \texttt{SpectralSpread} класс, который получает значение дисперсии спектра относительно арифметического среднего взвешенного (см. формулу \ref{eq:spread}). Класс наследуется от \texttt{SpectralFeature}.

Класс \texttt{SpectralSpread} имеет следующие методы:

\begin{itemize}
\item{\texttt{get(data, params)} --  метод, который принимает на вход массив отсчётов и массив \texttt{params}, где первым элементом идёт вычисленное арифметическое среднее взвешенное , а на выход выдаёт значение  дисперсии спектра относительно арифметического среднего взвешенного . }
\end{itemize}



\subsubsection{Класс \texttt{SpectralDissymmetry}}

Класс \texttt{SpectralDissymmetry} класс, который получает коэффициент асимметрии спектра (см. формулу \ref{eq:spread}). Класс наследуется от \texttt{SpectralFeature}.

Класс \texttt{SpectralDissymmetry} имеет следующие методы:

\begin{itemize}
\item{\texttt{get(data, params)} --  метод, который принимает на вход массив отсчётов и массив \texttt{params}, где первым элементом идёт вычисленное арифметическое среднее взвешенное , а на выход выдаёт значение коэффициент асимметрии спектра . }
\end{itemize}




\subsubsection{Класс \texttt{FeatureProcessing}}

Класс \texttt{FeatureProcessing} предназначен для

\begin{itemize}
\item{Поле \texttt{with\_mean} -- коэффициент сглаживания, который может принимать значения от 0 до 1.}
\item{Поле \texttt{with\_std} -- массив, который содержит в себе окно Хемминга.}
\item{Поле \texttt{with\_skew} -- количество каскадов в }
\item{Поле \texttt{with\_kurtosis} -- частота передискретизации.}
\item{\texttt{mean(data)} -- метод, }
\item{\texttt{std(data)} -- метод, который  делает вейвлет преобразования Добеши. }
\item{\texttt{skew(data)} -- метод, который преобразовывает данные искользуя экспоненциальное сглаживание.}
\item{\texttt{kurtosis(data)} -- метод, который передискретизирует данные в \texttt{rate} раз }
\item{\texttt{process\_feature(track)} -- метод, который}
\end{itemize}

\subsubsection{Класс \texttt{GenreClassificationModule}}

Класс \texttt{GenreClassificationModule} предназначен для

\begin{itemize}
\item{Поле \texttt{classifiers} -- коэффициент сглаживания, который может принимать значения от 0 до 1.}
\item{Поле \texttt{labels\_name} -- массив, который содержит в себе окно Хемминга.}
\item{Поле \texttt{cv} -- количество каскадов в }
\item{\texttt{cross\_validation\_predict(clf, data, labels)} -- метод, }
\item{\texttt{std(data)} -- метод, который  делает вейвлет преобразования Добеши. }
\item{\texttt{skew(data)} -- метод, который преобразовывает данные искользуя экспоненциальное сглаживание.}
\item{\texttt{kurtosis(data)} -- метод, который передискретизирует данные в \texttt{rate} раз }
\item{\texttt{process\_feature(track)} -- метод, который}
\end{itemize}




